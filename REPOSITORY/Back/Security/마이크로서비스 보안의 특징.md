마이크로서비스 보안의 특징과  설계시 고려할 점

## 모놀리식 애플리케이션의 보안 동작
- 요청을 서블릿 필터를 홀용해서 애플리케이션 수준에서 보안을 유지함
- 추가 접근 제어 절차로는 특정 메뉴, 기능에 접근 권한이 있는지에 대한 검증 절차를 수행함
- 내부 구성요소들(결제, 기능2 등)은 서블릿 필터에서 인증/권한을 다 확인했다고 가정을 하고 동작하기 때문에 요청의 정당성에 대해서는 고민하지 않음
- 만약 요청자가 누구인지, 어떠한 권한을 가지고 있는지에 대해 알아야 한다면 구성요소들이 공유하고 있는 웹세션을 참고함
- 요청이 애플리케이션 계층 내부로 들어오면 구성요소들 간 통신 보안에 대해서는 걱정하지 X
- 모놀리식 애플리케이션에서의 보안 절차는 중앙화된 단일 지점에서 시행함

## 마이크로서비스 아키텍처 보안의 고려사항
아래같은 상황을 고려
1. 공격 노출 지점이 넓어질수록 공격받을 위험도 증가
	- 모놀리식에서는 내부 구성요소간 통신은 JVM과 같은 애플리케이션 프로세스 내에서 발생한다.
	- 하지만 마이크로서비스는 자신만의 진입점을 각 따로 가지고 있고, 요청을 독립적으로 허용/거절함
	- 진입점이 많아지며 공격받을 수 있는 지점이 많아지는 단점이 존재
	- 연결되어 있는 모든 마이크로서비스는 동등한 수준의 보안으로 관리되어야 함
2. 보안 검증 지점 분리는 성능 저하를 초래
	- 개별 마이크로서비스는 독립적인 보안검증을 수행하여야 함
	- 각 진입점마다 보안 검증을 수행해야 하기 때문에 불필요한 중복 절차가발생할 수 있음
	- 이걸 해결하려면 네트워크 단위로 신뢰하거나, 보안 검증을 생략할 수 있음
	- 최근에는 '제로 트러스트 네트워크 원칙'으로 접근에 대한 요청에 철저하게 검증을 하고 검증 이후에도 최소한의 권한만 부여함
3. 배포 복잡성으로 인한 마이크로서비스 간 초기 신뢰 설정 어려움
	- 다뤄야 하는 비즈니스가 복잡해질 수록 마이크로서비스의 그룹 크기도 커짐
	- 때문에 수천개의 서비스를 가지고 있는 대규모 마이크로서비스 애플리케이션도 나오기 시작..
	- 개별 서비스 간 통신에서는 암호화가 되어야 하는 데이터가 존재하고, 인증서를 활용해서 해결할 수 있음 
	- 수신 측 서비스는 요청 측 서비스의 인증서를 검증하는 방법을 모두 알고 있어야 함
	- 개인키 유출 시 인증서를 해지하거나 관련 설정을 개별 서비스에 모두 적용해주어야 하기 때문에 초기 설정이 어려움
4. 다양한 마이크로서비스 간 통신 추적의 어려움
	- 보안 등 외부에서 어떠한 요청이 들어왔고, 해당 요청이 어떻게 처리 되어 나갔는지 추적해야함(로깅)
	- 예를 들어 알림 시스엠은 알림에 대한 접수,발송,재처리 등으로 분리되어 관리해야하고 하나의 유니크 ID 를 기반으로 접수, 발송, 재처리 모두에서 트래킹을 할 수 있어야 추적이 가능함
5. 컨테이너의 불변성으로 인한 자격증명과 접근제어 정책 유지의 어려움
	- 도커를 기반으로 서버를 띄울 때, 설정 파일들을 변경할 수 없게 하거나 컨테이너 내부를 항상 실행 상태로 유지하여야 함
	- 이유는 배포 절차의 단순함을 위해서이고, 데이터에 대한 유실 걱정을 줄여줌
	- 마이크로서비스의 접근 제어 정책 자체는 지속적으로 변경될 수 있음 
	- 때문에 최신 정책을 받아 동적으로 업데이트하는 방안이 필요함(푸시 모델 또는 풀 모델)
6. 마이크로서비스의 분산된 특성으로 인한 사용자 컨텍스트 공유의 어려움
	- 마이크로서비스에서는 모놀리식에서처럼 모든 내부 구성요소가 동일한 웹 세션을 공유하고 요청자에 대한 정보를 웹 세션을 통해 획득할 수 없음 -> 사용자 컨텍스트를 명시적으로 전달하여야 함
	- 어려운 점은 마이크로서비스 간에 전달하는 사용자 컨텍스트를 의도적으로 수정하지 않았는지 검증할 수 있는 방안이 필요하고 이건 보통 JWT 를 활용해서 사용자 컨텍스트를 공유하여 해결한다
7. 다중 개발 언어/프레임워크 지원 아키텍처는 더 다양한 보안 전문지식을 요구
	- 일반적으로 마이크로서비스 간 통신에서는 각 서비스가 제공하는 인터페이스에 의존함
	- 각 기술 스택에 맞게 최선의 보안 기준과 가이드라인을 적용하여야 함

## 사용자에 대한 인증
인증이라는 과정은 요청 당사자를 식별하는 절차를 의미
- 요청자를 식별하여 해당 마이크로서비스에 접근할 수 있는지 없는지를 판단하여야함
- 인증할 수 있는 방안은 다양하게 존재하며 다른 시스템이 사용자 인증에 대한 권한을 위임받아 진행할 수 있음
- OAuth 2.0 이 표준이 될 수 있음
- 사용자 ID와 비밀번호만으로 인증이 부족할 것 같을때 MFA 를 요구하여야 함
- 인증코드를 SMS 등으로 전달받아 추가 정보를 요구하는 과정으로 해킹을 막는데 효과적임
- 다른 방법으로 JWT, 인증서가 존재

## 무결성 검증
클라이언트가 마이크로서비스로 데이터 전송을 할 때, 중간에서 해커가 이를 가로채서 본인이 원하는대로 데이터를 조작하면? -> 때문에 이것을 막을 수 있는 무결성 검증 방안이 필요함

가장 흔하게는 메세지에 서명을 넣는 것이 있음
- TLS(Transport Layer Security)를 적용한 통신 채널로 전송되는 데이터는 무결성을 보장
- HTTPS 를 적용하면 TLS로 전송 계층 암호화 연결을 함으로써 메시지 전송 시에 무결성을 보장할 수 있음

## 보안 통신 설계 흐름 
1. 클라이언트가 보낸 요청값에 API게이트웨이에서 서명한 JWT 를 포함하여 기능1 서비스로 전달
2. 전달받은 JWT를 기능1 도메인의 STS(보안토큰서비스)로 전송하여 JWT를 검증함
3. 해당 도메인이 서명한 새로운 JWT 를 반환함
4. 기능1 서비스의 JWT 를 받아 기능2 서비스로 설정된 새로운 JWT와 바꿈
5. 위에서 획득한 JWT로 기능2 서비스에 접근





